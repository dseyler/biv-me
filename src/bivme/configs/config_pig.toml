
title = "Configuration file for biv-me"
version = "1.1.6" # for semantic versioning - Major.Minor.Patch sequence
# e.g software version 2.3.1 means that the software is in its second major version,
# with three additional functionalities added, and one patch fix implemented.
# When a developer fixes a bug in that version, the next version release is named version 2.3.2.

[modules]
preprocessing = true
fitting = true
# Define which modules you want to run. 
# preprocessing generates GPFiles and SliceInfo files for biv model fitting directly from a DICOM directory
# fitting carries out biv model fitting on a set of GPFiles and SliceInfo files
# If both are enabled, they will be run in sequence, such that biv models will be generated for each case within a DICOM directory
# If only fitting is enabled, biv models will be created from existing GPFiles
# If only preprocessing is enabled, GPFiles and SliceInfo files will be created for each case within a DICOM directory 
# Allowed values:
# * true    : Run this module
# * false    : Do not run this module
# Default: true

[logging]
show_detailed_logging = true
# Change the log visibility for preprocessing and fitting. Useful for debugging and oversight.
# If true, detailed logs will show on the console.
# Default: true

generate_log_file = true
# Decide whether or not to save the log files. If true, a .log file will be generated each for preprocessing and fitting
# Default: true

[plotting]
generate_plots_preprocessing = true
# Define whether to generate html plots of exported contours after preprocessing (not corrected for breathhold). 
# Default: false

generate_plots_fitting = true
# Define whether to generate html plots of models and contours during fitting (corrected for breathhold).
# Default: true

include_images = true
# Define whether to include images in html plots (if preprocessing has been performed). This will add processing time and cause html files to become large, so use only if you want to overlay contours and/or models with images.
# Default: true

export_images = true
# Define whether to export images in vtk format (if preprocessing has been performed). This will add processing time and take up a lot of storage space, so only use if you want to create visualisations of models and images. Images are only exported after fitting.
# Default: false

#
#
#
#
#
#
#
#
###### Preprocessing parameters
#
#
#
#
#
#
#
#

# Below are the parameters used to configure preprocessing of DICOM files 
# Skip these if you do not intend to run preprocessing
[input_pp]
source = "/Users/dseyler/Documents/Marsden_Lab/Cine_MRI/cases"
# Define the directory containing raw dicoms. Files must be grouped into one folder per case
# Default: "../../example/dicoms"

batch_ID = "TR-1311"
# Define the id of the batch you are processing. This will define the name of the folder that processed outputs will be written to
# Default: "test"

analyst_id = "analyst1"
# Define the id of the analyst performing the preprocessing. Useful e.g. if view predictions need to be corrected
# Default: "analyst1"

processing = "../../pig/processing"
# Define the directory where processing files (including view predictions, segmentations) will be written
# Default: "../../example/processing"

states = "../../pig/states"
# Define the directory where view predictions and log files will be written out to
# Default: "../../example/states"

[view-selection]
option = "load"
# Define how you would like to perform view selection
# * "default" : View predictions are generated by using metadata and image data
# * "image-only": View predictions are generated using image data only
# * "load" : View predictions are loaded from the states folder, if they exist
# Default: "default"

correct_mode = "automatic"
# Define whether you would like to manually review and correct view predictions. "adaptive" is generally recommended to avoid downstream errors.
# * "manual": will launch a GUI after completing view predictions to allow you to correct any mispredictions
# * "adaptive": will only launch a GUI if there are any poor predictions or missing views
# * "automatic": will not launch the GUI and will use the predictions as they are with no interruption
# Default: "adaptive"

use_precomputed_segmentations = true
# Define whether to use precomputed segmentations instead of running segmentation
# * true: Load existing segmentations from processing directory
# * false: Run segmentation pipeline
# Default: false

[contouring]
smooth_landmarks = false
# Define whether you would like to apply temporal smoothing to landmarks (mitral, tricuspid, pulmonary, and aortic valves, RV insertion points, apex points)
# Temporal smoothing of landmarks helps to regularise the resulting fit and avoids sampling errors due to image resolution 
# Allowed values:
# * true    : Apply smoothing
# * false    : Do not apply smoothing
# Default: true

[output_pp]
overwrite = true
# Define to overwrite the processed folder and outputs of an already preprocessed case, if it exists
# Default: false

output_directory = "../../pig/guidepoints"
# Define the directory where GPFiles will be created
# If fitting and preprocessing are both enabled, this output_directory will also be the gp_directory used for fitting (see below)
# Default: "../../example/guidepoints"

#
#
#
#
#
#
#
#
###### Fitting parameters
#
#
#
#
#
#
#
#

# Below are the parameters used to configure biv model fitting 
[input_fitting]
gp_directory = "../../pig/guidepoints/default"
# Define the directory containing guidepoint files
# If fitting and preprocessing are both enabled, this gp_directory will also be the output_directory used in preprocessing (see above)
# default: "../../example/guidepoints/default"

gp_suffix = ""
# Define guidepoints to use if we do not want to fit all the models in the input folder
# Default: ""

si_suffix = ""
# Define slice info to use if multiple SliceInfo.txt file are available
# Default: ""

[breathhold_correction]
shifting = "derived_from_ed" # derived_from_ed, average_all_frames, none
# Define the method used for breathhold misregistration correction.
# Allowed values:
# * "derived_from_ed"      : The correction is calculated at ED only and propagated to all the frames
# * "average_all_frames"  : Breathold misregistration is calculated by averaging slice shift over all frame
# * "none"  : no correction applied
# Default: "derived_from_ed"

ed_frame = 4  # ED frame

[gp_processing]
sampling = 1
# Controls whether to sample the data points or not. This can be useful when dealing with very dense data points.
# sampling = 1 means all the points are kept, sampling = 2 means that 1 every two points is kept etc.
# Default: 1

num_of_phantom_points_mv = 30
# Controls the number of points to be generated on the mitral valve annulus
# Default: 30. Use 0 if you do not want any to be generated

num_of_phantom_points_tv = 30
# Controls the number of points to be generated on the tricuspid valve annulus
# Default: 30. Use 0 if you do not want any to be generated

num_of_phantom_points_pv = 20
# Controls the number of points to be generated on the pulmonary valve annulus
# Default: 20. Use 0 if you do not want any to be generated

num_of_phantom_points_av = 20
# Controls the number of points to be generated on the aortic valve annulus
# Default: 20. Use 0 if you do not want any to be generated

filter_sax_lv_epicardial = true
# Enable filtering of SAX_LV_EPICARDIAL guidepoints for specified slice IDs.
# This filter removes points on the septal side of a plane fitted to first/last RV_septum points.
# Default: false

filter_sax_lv_epicardial_slice_ids = [17, 18]
# List of slice IDs (frameIDs) to filter SAX_LV_EPICARDIAL points for.
# Default: [17, 18]

filter_3ch_lv_epicardial = true
# Filter LAX_LV_EPICARDIAL guidepoints that are within 2 pixels of 
# LAX_RV_SEPTUM guidepoints from the same frameID (for 3ch views).
# This filtering occurs after breathhold correction.
# Default: false

[fitting_weights]
guide_points = 100.0
convex_problem = 1e6
transmural = 0.001
pulmonary_artery_circularity = 1000000.0
# Weight for pulmonary artery circularity regularization. 
# Set to > 0 to enable circularity enforcement during fitting.
# Higher values enforce more circular pulmonary artery shapes.
# Default: 0.0

[pulmonary_artery_refitting]
enabled = true
# Enable refitting step that replaces pulmonary valve guidepoints with 
# longitudinal-aligned phantom points after initial fitting.
# After fitting each phase, new phantom points are generated in a plane orthogonal
# to the longitudinal direction (apex to mitral valve), centered at the fitted
# pulmonary valve centroid with equivalent diameter. The phase is then refit.
# Default: false

[temporal_smoothing]
enabled = true
# Enable temporal smoothing of control mesh coordinates across cardiac phases.
# This reduces jerkiness in the fitted models over time using Fourier smoothing.
# Default: false

method = "fourier"
# Smoothing method to use. Currently only "fourier" is supported.
# Default: "fourier"

cutoff_frequency = 0.9
# Base cutoff frequency (fraction of Nyquist frequency). This is used as max_cutoff for distance-based smoothing.
# Default: 0.8

use_distance_based_smoothing = true
# If true, apply variable smoothing based on distance to guidepoints.
# Control points close to guidepoints use less smoothing (higher cutoff), 
# while points far from guidepoints use more smoothing (lower cutoff).
# Default: true

min_cutoff_frequency = 0.2
# Minimum cutoff frequency for points far from guidepoints (more smoothing).
# Default: 0.3

max_cutoff_frequency = 0.8
# Maximum cutoff frequency for points close to guidepoints (less smoothing).
# Default: 0.8

characteristic_length = 3.0
# Characteristic length (in pixels) for smooth transition from min_cutoff to max_cutoff.
# The transition follows a sigmoid-like function based on distance to nearest guidepoint.
# Note: Distances are computed in 3D space; this value should be set relative to typical 
# pixel spacing in your images (e.g., ~1-2mm per pixel).
# Default: 5.0

[output_fitting]
export_control_mesh = false
# Decide whether or not to save the coarse mesh. If true, the coarse mesh will be generated (format: mesh_format)
# Default: false

mesh_format = ".vtk"
# Allowed values:
# * ".obj" : write the mesh as a wavefront .obj file - compatible with most computer graphics/mesh visualisation software
# * ".vtk" : write the mesh as to vtk format
# * "none" : Only the .txt files containing the fitted model control meshes are written.
# Default: ".vtk"

closed_mesh = false
# Option to export mesh object as closed or not closed
# Default: false

merged_mesh = true
# Option to export the three main meshes (LV_ENDOCARDIAL, RV_ENDOCARDIAL, EPICARDIAL) 
# merged together as a single OBJ file for smoothed refitted models.
# Valve surfaces are excluded, leaving valve openings unclosed.
# Only generates merged mesh if all three surfaces are in output_meshes.
# Default: false

output_meshes = ["LV_ENDOCARDIAL", "RV_ENDOCARDIAL", "EPICARDIAL"]
# Allowed values:
# * "LV_ENDOCARDIAL" : LV endocardium
# * "RV_ENDOCARDIAL" : RV endocardium - RVFW and RVS
# * "EPICARDIAL" : Epicardium

overwrite = false
# Define to overwrite the output mesh if it exists
# Default: false

output_directory = "../output/"
# Define where to save the fitted models and files
# default: "../output/"

[multiprocessing]
workers = 6
# number of workers to use for multi processing
# default: 1